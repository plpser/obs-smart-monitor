# 🎬 智能文件监控程序 + OBS自动化 - 增强版

## 🎯 功能特点
- 🔄 实时监控指定文件的变化
- 📝 当文件内容发生变化时，自动获取并显示最后一行内容  
- ✨ **智能内容提取**：自动去除时间戳和用户标识，提取纯净的用户发言内容
- 🔢 **智能数字检测**：自动检测用户发言中是否包含"看"字和数字的组合，并提取数字
- 🎬 **OBS自动场景切换**：基于检测到的数字自动切换OBS场景
- ⏰ **智能时间控制**：120秒自动返回默认场景，冷却期间拒绝新的切换请求
- 🆕 支持文件创建和修改事件
- 🗑️ 智能处理文件删除并自动切换到最新文件
- ⚡ 防止重复触发机制
- 🎨 优化的输出界面，信息一目了然
- ⏱️ 可配置的监控频率

## ⚙️ 监控参数配置

### 📈 监控频率设置
- **内容变化检测**: 0.5秒间隔（实时响应）
- **新文件检查**: 每10分钟自动检查
- **自动文件切换**: 发现更新文件时立即切换

### 🎨 输出优化
- **图标标识**: 使用emoji图标区分不同类型的消息
- **时间戳**: 精确到秒的时间显示
- **分层信息**: 清晰的信息层级结构
- **颜色区分**: 不同类型事件使用不同的视觉标识

## 🚀 安装和使用

### 1. 📦 安装依赖
```bash
# 方法1：自动安装
python install_dependencies.py

# 方法2：手动安装
pip install watchdog obsws-python
```

### 2. 🎬 OBS Studio 设置
1. 打开 OBS Studio
2. 点击 `工具` -> `WebSocket 服务器设置`
3. 勾选 `启用 WebSocket 服务器`
4. 设置端口 (默认: 4455)
5. 设置密码 (可选，建议留空)
6. 点击 `确定` 保存设置

### 3. 🧪 测试OBS连接
```bash
python test_obs.py
```

### 4. ▶️ 运行主程序
```bash
python fileMonitor.py
```

### 5. 🔧 选择配置
程序启动后会提供以下选择：
- **是否启用OBS功能**：选择y启用自动场景切换
- **监控模式**：选择实际模式或测试模式

### 4. 🧪 测试功能
- 📝 修改监控文件内容并保存
- 🗑️ 删除监控文件测试自动切换
- 📁 创建新的用户发言记录文件测试自动检测

## 📊 输出界面说明

### 🎯 事件类型标识
- 📅 `[时间]` - 普通信息
- ✅ `[时间]` - 成功操作
- ⚠️ `[时间]` - 警告信息
- ❌ `[时间]` - 错误信息
- 📄 `[时间]` - 文件内容变化
- 🔄 `[时间]` - 文件切换

### 📋 信息层级
```
📄 [14:30:15] 文件内容变化
   📁 文件: 用户发言记录_2025_01_03.txt
   📝 原始内容: 2025-08-29 22:53:09[用户发言]t： 看123号房间
   ✨ 用户发言: 看123号房间
   🔢 检测结果: 发现“看”字和数字 -> 123
   🎬 [14:30:15] 场景已切换到编号 123
   --------------------------------------------------
```

## 🎬 OBS自动场景切换功能

### 🎯 核心功能
- **自动连接**：WebSocket自动连接OBS Studio
- **场景映射**：自动获取所有场景并生成编号映射
- **智能切换**：根据用户发言中的数字自动切换对应场景
- **时间控制**：120秒后自动返回默认场景
- **冷却机制**：在切换期间内拒绝新的切换请求

### 🛠️ 配置文件结构
程序会自动生成 `obs_config.json` 配置文件：

```json
{
    "obs_connection": {
        "host": "localhost",
        "port": 4455,
        "password": "",
        "connect_timeout": 5,
        "reconnect_interval": 10
    },
    "scene_settings": {
        "default_scene": "默认场景",
        "switch_duration": 120,
        "scenes": {
            "1": {
                "name": "场景1",
                "number": 1,
                "enabled": true,
                "description": "场景1: 场景1"
            }
        }
    },
    "monitoring": {
        "enabled": true,
        "auto_switch": true,
        "debug_mode": false
    }
}
```

### 🎮 使用流程

1. **用户发言**：`看123号房间`
2. **内容提取**：提取纯净内容 `看123号房间`
3. **数字检测**：检测到`看`字和数字`123`
4. **场景匹配**：查找编号123对应的场景
5. **自动切换**：OBS切换到目标场景
6. **定时返回**：120秒后自动返回默认场景

### ⏰ 时间控制机制

- **切换保持时间**：120秒（可配置）
- **冷却期防止**：在120秒内无法再次触发切换
- **自动返回**：超时后自动返回到默认场景

## 🔢 智能数字检测功能

### 🎯 功能说明
程序能够自动检测用户发言中是否同时包含“看”字和数字：
- **满足条件**：内容包含“看”字 且 包含数字
- **返回结果**：提取第一个出现的数字（支持整数和小数）
- **无匹配**：返回None并显示未检测到的提示

### 📝 支持的数字格式
- **整数**：`0, 1, 123, 456`
- **小数**：`7.5, 12.34, 100.0`
- **多数字**：返回第一个数字

### 📊 检测示例

#### ✅ 成功检测的例子
```
输入: “看123号房间”     -> 输出: 123
输入: “看房间456”       -> 输出: 456  
输入: “我想看7.5个小时”  -> 输出: 7.5
输入: “看房间88和99”   -> 输出: 88 (第一个数字)
输入: “看0号”           -> 输出: 0
输入: “看第1集”         -> 输出: 1
```

#### ❌ 无法检测的例子
```
输入: “看看这个”         -> 无数字
输入: “房间123很好”       -> 无“看”字
输入: “想看看电影”       -> 无数字
输入: “看”               -> 无数字
输入: “”                 -> 空内容
```

## ✨ 智能内容提取功能

### 🔍 支持的格式
程序能够自动识别并提取以下格式的用户发言内容：

1. **完整时间戳格式**：
   ```
   2025-08-29 22:53:09[用户发言]t： 有黄水吗
   ⬇️ 提取结果: 有黄水吗
   ```

2. **简化标签格式**：
   ```
   [用户发言]张三： 今天天气怎么样？
   ⬇️ 提取结果: 今天天气怎么样？
   ```

3. **时间用户名格式**：
   ```
   14:30:15 李四： 大家好
   ⬇️ 提取结果: 大家好
   ```

### 🤖 智能处理
- **自动去除**: 时间戳、用户标识、用户名等前缀信息
- **空内容检测**: 自动检测并标识空内容
- **原始内容保留**: 无法识别的格式保留原始内容
- **多格式支持**: 兼容多种日志格式

## ⚡ 性能优化

### 📈 监控效率
- **快速响应**: 0.5秒内容检测间隔确保实时性
- **智能检查**: 10分钟新文件检查间隔平衡性能和及时性
- **事件防抖**: 避免重复触发机制

### 💾 资源消耗
- **低CPU占用**: 高效的文件监控算法
- **最小内存**: 仅加载必要的文件内容
- **自动清理**: 智能的资源管理

## 🛠️ 高级功能

### 🔄 自动文件切换
- 监控文件被删除时自动切换到最新文件
- 发现更新的用户发言记录文件时主动切换
- 保持监控的连续性

### 📊 实时状态显示
- 当前监控文件信息
- 监控参数配置
- 功能状态说明

## 📝 注意事项
- ✅ 程序支持 UTF-8 编码的文本文件
- ⌨️ 按 Ctrl+C 可以停止监控
- 🔐 确保有文件的读取权限
- 📁 确保目标目录存在且可访问

## 🎮 快速开始示例

1. **启动程序**
   ```bash
   python fileMonitor.py
   ```

2. **选择测试模式** (输入 `2`)
   ```
   请选择监控模式:
      1️⃣  实际模式 - 监控 FlyAiLive1 日志目录
      2️⃣  测试模式 - 监控本地 test_logs 文件夹
   
   ➡️  请输入选择 (1/2): 2
   ```

3. **程序会自动**：
   - 🔍 查找最新的用户发言记录文件
   - 📊 显示文件信息和当前最后一行
   - 🚀 启动监控服务

4. **测试功能**：
   - ✏️ 用记事本打开测试文件并添加新内容
   - 👀 观察程序实时显示最后一行变化
   - 🗑️ 删除文件测试自动切换功能